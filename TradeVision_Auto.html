<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeVision | Native Core Loader</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

    <style>
        :root { --bg: #050505; --panel: #111; --text: #ccc; --gold: #D4AF37; --cyan: #0ff; --err: #ff4444; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: monospace; height: 100vh; display: flex; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 350px; background: var(--panel); border-right: 1px solid #333; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        h1 { margin: 0; font-size: 16px; color: #fff; letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        h1 span { color: var(--gold); }
        
        .drop-area {
            border: 2px dashed #444; border-radius: 4px; padding: 30px 20px; text-align: center;
            cursor: pointer; transition: 0.2s; position: relative; background: #0a0a0a; color: #666;
        }
        .drop-area:hover { border-color: var(--gold); color: #fff; background: #1a1600; }
        .drop-area input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor: pointer; }
        
        /* CONSOLE */
        .console {
            background: #000; border: 1px solid #333; flex-grow: 1; overflow-y: auto; 
            font-size: 11px; padding: 10px; font-family: 'Consolas', monospace; color: #0f0;
            white-space: pre-wrap;
        }
        .log-err { color: var(--err); background: rgba(255,0,0,0.1); }
        .log-warn { color: orange; }
        .log-data { color: #888; }

        .btn {
            background: var(--gold); color: #000; border: none; padding: 12px; font-weight: 800;
            cursor: pointer; text-transform: uppercase; border-radius: 4px; opacity: 0.5; pointer-events: none;
        }
        .btn.active { opacity: 1; pointer-events: all; }
        
        /* CHART */
        #chart { flex-grow: 1; position: relative; }
        .watermark { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            color: #222; font-size: 30px; font-weight: bold; pointer-events: none; text-align: center;
        }
    </style>
</head>
<body>

<div class="sidebar">
    <h1>TradeVision <span>NATIVE</span></h1>
    
    <div class="drop-area" id="dropZone">
        <div>ðŸ“‚ DRAG .CSV FILE HERE</div>
        <div style="font-size:10px; margin-top:5px;">Supports: Standard, Excel-CSV, Weird Headers</div>
        <input type="file" id="fileInput" accept=".csv, .txt">
    </div>

    <div>System Log:</div>
    <div class="console" id="console">
        <div>> Core Initialized.</div>
        <div>> Ready for file drop...</div>
    </div>

    <button id="btnSim" class="btn">Generate Future</button>
</div>

<div id="chart">
    <div class="watermark" id="watermark">AWAITING DATA</div>
</div>

<script>
    // --- LOGGER ---
    const consoleDiv = document.getElementById('console');
    function log(msg, type='info') {
        const div = document.createElement('div');
        div.innerText = `> ${msg}`;
        if(type==='err') div.className = 'log-err';
        if(type==='warn') div.className = 'log-warn';
        if(type==='data') div.className = 'log-data';
        consoleDiv.appendChild(div);
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }

    // --- CHART SETUP ---
    const chartDiv = document.getElementById('chart');
    const chart = LightweightCharts.createChart(chartDiv, {
        layout: { background: { color: '#050505' }, textColor: '#888' },
        grid: { vertLines: { color: '#111' }, horzLines: { color: '#111' } },
        timeScale: { borderColor: '#333', timeVisible: true },
        crosshair: { mode: 0 }
    });
    
    const candleSeries = chart.addCandlestickSeries({ upColor: '#089981', downColor: '#f23645', borderVisible: false });
    const simSeries = chart.addCandlestickSeries({ upColor: '#0ff', downColor: '#f0f', borderVisible: true, wickUpColor: '#0ff', wickDownColor: '#f0f' });

    window.addEventListener('resize', () => {
        chart.applyOptions({ width: chartDiv.clientWidth, height: chartDiv.clientHeight });
    });

    // --- NATIVE PARSER ---
    document.getElementById('fileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;

        log(`Reading ${file.name} (${(file.size/1024).toFixed(1)} KB)...`);
        
        const reader = new FileReader();
        reader.onload = (event) => {
            const text = event.target.result;
            parseCSV(text);
        };
        reader.onerror = () => log("Error reading file.", 'err');
        reader.readAsText(file); // Safe for CSV/TXT
    });

    function parseCSV(rawText) {
        const lines = rawText.trim().split('\n');
        if(lines.length < 2) {
            log("Error: File is empty or has no data rows.", 'err');
            return;
        }

        // 1. CLEAN HEADERS (The Secret Sauce)
        // Remove special chars like (ç«„) and convert to lowercase for matching
        const rawHeader = lines[0];
        const cleanHeader = rawHeader.replace(/[^a-zA-Z0-9,]/g, "").toLowerCase(); 
        log(`Detected Header: ${cleanHeader}`, 'data');

        const headers = cleanHeader.split(',');
        
        // 2. MAP COLUMNS
        const map = { t: -1, o: -1, h: -1, l: -1, c: -1 };
        headers.forEach((h, i) => {
            if(h.includes('date') || h.includes('time')) map.t = i;
            if(h.includes('open')) map.o = i;
            if(h.includes('high')) map.h = i;
            if(h.includes('low')) map.l = i;
            if(h.includes('close')) map.c = i;
        });

        // Validation
        if(map.t === -1 || map.c === -1) {
            log(`CRITICAL: Could not find 'Date' or 'Close' columns.`, 'err');
            log(`Found headers: [${headers.join(', ')}]`, 'warn');
            return;
        }
        log(`Mapped Cols: Time[${map.t}], Open[${map.o}], Close[${map.c}]`);

        // 3. PARSE ROWS
        const data = [];
        let errors = 0;
        
        for(let i=1; i<lines.length; i++) {
            let line = lines[i].trim();
            if(!line) continue;

            // Handle "Quoted, Comma" issue (e.g. "1,234.50")
            // Regex splits by comma ONLY if followed by even number of quotes
            const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            
            try {
                // Parse Time
                let tStr = parts[map.t].replace(/"/g, ''); // Remove quotes
                let dateVal;

                // Detect Date Format
                if(tStr.includes('-') || tStr.includes('/')) {
                    dateVal = new Date(tStr).getTime() / 1000; // String Date -> Unix
                } else {
                    dateVal = parseFloat(tStr); // Unix or Excel Serial
                    if(dateVal > 10000000000) dateVal = dateVal / 1000; // MS to Sec
                }

                if(isNaN(dateVal)) throw new Error("Invalid Date");

                // Parse Prices (Handle quotes)
                const o = parseFloat(parts[map.o].replace(/"/g, ''));
                const h = parseFloat(parts[map.h].replace(/"/g, ''));
                const l = parseFloat(parts[map.l].replace(/"/g, ''));
                const c = parseFloat(parts[map.c].replace(/"/g, ''));

                if(isNaN(c)) throw new Error("Invalid Price");

                data.push({ time: dateVal, open: o, high: h, low: l, close: c });

            } catch(e) {
                errors++;
                if(errors < 3) log(`Row ${i} Error: ${e.message}`, 'warn');
            }
        }

        if(data.length === 0) {
            log("Failed to parse any valid rows.", 'err');
            return;
        }

        // Success
        data.sort((a,b) => a.time - b.time);
        log(`Success! Loaded ${data.length} candles.`);
        if(errors > 0) log(`(Skipped ${errors} bad rows)`, 'warn');
        
        // Render
        candleSeries.setData(data);
        chart.timeScale().fitContent();
        document.getElementById('watermark').style.display = 'none';
        document.getElementById('btnSim').classList.add('active');
        
        // Store for Sim
        window.historyData = data;
    }

    // --- SIMULATION ---
    document.getElementById('btnSim').addEventListener('click', () => {
        const data = window.historyData;
        if(!data) return;

        log("Running Monte Carlo Simulation...");
        
        // 1. Calculate Volatility (ATR-ish)
        const lookback = Math.min(data.length, 20);
        const subset = data.slice(-lookback);
        let sumRange = 0;
        subset.forEach(d => sumRange += (d.high - d.low));
        const avgRange = sumRange / lookback;
        
        // 2. Generate Future
        const simData = [];
        let current = data[data.length-1];
        // Guess interval
        const interval = data.length > 1 ? (data[1].time - data[0].time) : 86400;

        for(let i=0; i<30; i++) { // 30 Bars
            const shock = (Math.random() - 0.48) * avgRange; // Slight Bull Bias
            const open = current.close;
            const close = open + shock;
            
            const high = Math.max(open, close) + (Math.random() * avgRange * 0.4);
            const low = Math.min(open, close) - (Math.random() * avgRange * 0.4);
            
            current = {
                time: current.time + interval,
                open: open, high: high, low: low, close: close
            };
            simData.push(current);
        }
        
        simSeries.setData(simData);
        log("Projection generated (Cyan).");
    });
</script>
</body>
</html>
