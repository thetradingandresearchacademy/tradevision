<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeVision | Universal Institutional Loader</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

    <style>
        :root { --bg: #000; --panel: #111; --text: #ddd; --gold: #D4AF37; --cyan: #0ff; --err: #f44; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', monospace; height: 100vh; display: flex; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 320px; background: var(--panel); border-right: 1px solid #333; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        h1 { margin: 0; font-size: 18px; color: #fff; letter-spacing: 1px; }
        h1 span { color: var(--gold); }
        
        .drop-area {
            border: 2px dashed #444; border-radius: 6px; padding: 40px 20px; text-align: center;
            cursor: pointer; transition: 0.2s; position: relative; background: #0a0a0a;
        }
        .drop-area:hover { border-color: var(--gold); background: #1a1600; }
        .drop-area input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor: pointer; }
        
        /* CONSOLE (To see what's happening) */
        .console {
            background: #000; border: 1px solid #333; height: 150px; overflow-y: auto; 
            font-size: 10px; padding: 10px; font-family: monospace; color: #0f0;
            border-radius: 4px;
        }
        .log-err { color: var(--err); }
        .log-warn { color: orange; }

        .btn {
            background: var(--gold); color: #000; border: none; padding: 12px; font-weight: 800;
            cursor: pointer; text-transform: uppercase; border-radius: 4px; opacity: 0.5; pointer-events: none;
        }
        .btn.active { opacity: 1; pointer-events: all; }
        
        /* CHART */
        #chart { flex-grow: 1; position: relative; }
        .watermark { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            color: #333; font-size: 40px; font-weight: bold; pointer-events: none;
        }
    </style>
</head>
<body>

<div class="sidebar">
    <h1>TradeVision <span>PRO</span></h1>
    
    <div style="font-size:12px; color:#888;">Step 1: Upload Data</div>
    <div class="drop-area" id="dropZone">
        <div>ðŸ“‚ DRAG FILE HERE</div>
        <div style="font-size:10px; color:#666; margin-top:5px;">Supports: .CSV, .XLSX, .XLS</div>
        <input type="file" id="fileInput" accept=".csv, .xlsx, .xls">
    </div>

    <div style="font-size:12px; color:#888;">System Log:</div>
    <div class="console" id="console">
        <div>> System Ready.</div>
        <div>> Waiting for file...</div>
    </div>

    <button id="btnSim" class="btn">Generate Future</button>
</div>

<div id="chart">
    <div class="watermark" id="watermark">NO DATA LOADED</div>
</div>

<script>
    // --- UTILS: LOGGER ---
    const consoleDiv = document.getElementById('console');
    function log(msg, type='info') {
        const div = document.createElement('div');
        div.innerText = `> ${msg}`;
        if(type==='err') div.className = 'log-err';
        if(type==='warn') div.className = 'log-warn';
        consoleDiv.appendChild(div);
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }

    // --- 1. CHART SETUP ---
    const chartDiv = document.getElementById('chart');
    const chart = LightweightCharts.createChart(chartDiv, {
        layout: { background: { color: '#000' }, textColor: '#ccc' },
        grid: { vertLines: { color: '#111' }, horzLines: { color: '#111' } },
        timeScale: { borderColor: '#333' }
    });
    
    const candleSeries = chart.addCandlestickSeries({ upColor: '#089981', downColor: '#f23645', borderVisible: false });
    const simSeries = chart.addCandlestickSeries({ upColor: '#0ff', downColor: '#f0f', borderVisible: true, wickUpColor: '#0ff', wickDownColor: '#f0f' });

    window.addEventListener('resize', () => {
        chart.applyOptions({ width: chartDiv.clientWidth, height: chartDiv.clientHeight });
    });

    // --- 2. UNIVERSAL PARSER (SheetJS Powered) ---
    document.getElementById('fileInput').addEventListener('change', handleFile);

    async function handleFile(e) {
        const file = e.target.files[0];
        if(!file) return;
        
        log(`Reading: ${file.name}...`);
        
        try {
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data);
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            
            // Convert to JSON (Array of Arrays is safer for weird headers)
            const rawRows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
            
            if(rawRows.length < 2) throw new Error("File is empty");
            
            log(`Loaded ${rawRows.length} rows. Parsing headers...`);
            processData(rawRows);
            
        } catch(err) {
            log(`FATAL: ${err.message}`, 'err');
        }
    }

    function processData(rows) {
        // 1. Find Header Row (Look for row containing "open" and "close")
        let headerIdx = -1;
        let map = { t: -1, o: -1, h: -1, l: -1, c: -1 };
        
        for(let i=0; i < Math.min(rows.length, 10); i++) {
            const rowStr = rows[i].map(x => String(x).toLowerCase()).join(' ');
            if(rowStr.includes('open') && rowStr.includes('close')) {
                headerIdx = i;
                // Map columns
                rows[i].forEach((col, idx) => {
                    const c = String(col).toLowerCase().replace(/[^a-z]/g, ''); // Clean "Open(ç«„" -> "open"
                    if(c.includes('date') || c.includes('time')) map.t = idx;
                    if(c.includes('open')) map.o = idx;
                    if(c.includes('high')) map.h = idx;
                    if(c.includes('low')) map.l = idx;
                    if(c.includes('close')) map.c = idx;
                });
                break;
            }
        }

        if(headerIdx === -1) {
            log("Error: Could not find OHLC headers. Checking standard format...", 'warn');
            // Fallback: Assume Standard Order [Date, Open, High, Low, Close] if headers missing
            map = { t:0, o:1, h:2, l:3, c:4 };
            headerIdx = 0; // Skip nothing
        } else {
            log(`Headers found at row ${headerIdx+1}. Mapping: [${map.t}, ${map.o}, ${map.h}, ${map.l}, ${map.c}]`);
        }

        // 2. Extract Data
        const cleanData = [];
        for(let i = headerIdx + 1; i < rows.length; i++) {
            const row = rows[i];
            if(!row[map.c]) continue; // Skip empty lines

            // Parse Time
            let timeVal = row[map.t];
            let date;
            
            // SheetJS parses dates automatically sometimes, or returns Excel serial
            if(typeof timeVal === 'number') {
                if(timeVal > 50000) date = timeVal / 1000; // Unix ms -> sec (approx check)
                else if(timeVal > 1000000000) date = timeVal; // Unix sec
                else {
                    // Excel Serial Date Conversion
                    date = (timeVal - 25569) * 86400; 
                }
            } else {
                // String Date
                date = new Date(timeVal).getTime() / 1000;
            }

            if(isNaN(date)) continue;

            cleanData.push({
                time: date,
                open: parseFloat(row[map.o]),
                high: parseFloat(row[map.h]),
                low: parseFloat(row[map.l]),
                close: parseFloat(row[map.c])
            });
        }

        // Sort and Render
        cleanData.sort((a,b) => a.time - b.time);
        log(`Successfully parsed ${cleanData.length} candles.`);
        
        candleSeries.setData(cleanData);
        document.getElementById('watermark').style.display = 'none';
        document.getElementById('btnSim').classList.add('active');
        
        chart.timeScale().fitContent();
        
        // Save for Sim
        window.historyData = cleanData;
    }

    // --- 3. SIMULATION LOGIC ---
    document.getElementById('btnSim').addEventListener('click', () => {
        const data = window.historyData;
        if(!data) return;
        
        log("Generating Future Projection...");
        
        // Calculate Volatility (last 20 bars)
        let sumVar = 0;
        const lookback = Math.min(data.length, 20);
        const subset = data.slice(-lookback);
        
        subset.forEach(d => sumVar += (d.high - d.low));
        const avgRange = sumVar / lookback;
        
        // Generate 26 Bars (6 Months approx)
        let current = data[data.length-1];
        const simData = [];
        const interval = data[1].time - data[0].time; // Detect timeframe
        
        for(let i=0; i<26; i++) {
            const drift = (Math.random() - 0.45) * avgRange; // Slight bias
            const open = current.close;
            const close = open + drift;
            const high = Math.max(open, close) + (Math.random() * avgRange * 0.5);
            const low = Math.min(open, close) - (Math.random() * avgRange * 0.5);
            
            current = {
                time: current.time + interval,
                open: open, high: high, low: low, close: close
            };
            simData.push(current);
        }
        
        simSeries.setData(simData);
        log("Projection Complete.");
    });

</script>
</body>
</html>
