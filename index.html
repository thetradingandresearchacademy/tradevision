<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeVision Pro | Vercel Edition</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg: #000000;
            --panel: #111111;
            --text: #e0e0e0;
            --gold: #D4AF37;
            --green: #089981;
            --red: #f23645;
            --cyan: #00FFFF;
        }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, monospace; height: 100vh; display: flex; flex-direction: column; }
        
        /* HEADER */
        .header {
            padding: 15px 20px;
            background: var(--panel);
            border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand { font-size: 18px; font-weight: bold; letter-spacing: -1px; }
        .brand span { color: var(--gold); }
        
        /* CONTROLS */
        .controls {
            padding: 15px 20px;
            display: flex; gap: 20px; align-items: center;
            border-bottom: 1px solid #222;
        }
        
        /* NATIVE FILE INPUT STYLING */
        input[type="file"] {
            color: #888;
            font-size: 12px;
        }
        input[type="file"]::file-selector-button {
            background: var(--gold); border: none; padding: 8px 16px; color: black; font-weight: bold; cursor: pointer; margin-right: 10px; border-radius: 4px;
        }
        input[type="file"]::file-selector-button:hover { opacity: 0.9; }

        /* STATUS BADGES */
        .badges { display: flex; gap: 15px; margin-left: auto; font-size: 13px; font-family: 'Consolas', monospace; }
        .badge { display: flex; flex-direction: column; align-items: flex-end; }
        .badge label { font-size: 10px; color: #666; text-transform: uppercase; }
        .badge div { font-weight: bold; color: var(--text); }
        
        /* CHART */
        #chart-container { flex-grow: 1; position: relative; }
        .watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #333; font-size: 20px; font-weight: bold; pointer-events: none; }
        
        /* LOG CONSOLE */
        #console {
            height: 120px; background: #050505; border-top: 1px solid #333;
            padding: 10px; font-family: 'Consolas', monospace; font-size: 11px; color: #888; overflow-y: auto;
        }
        .log-row { margin-bottom: 4px; border-bottom: 1px solid #111; padding-bottom: 2px; }
        .success { color: var(--green); }
        .error { color: var(--red); }
        .warn { color: var(--gold); }
    </style>
</head>
<body>

    <div class="header">
        <div class="brand">TradeVision <span>VERCEL</span></div>
        <div style="font-size: 10px; color: #666;">Institutional Edition v3.0</div>
    </div>

    <div class="controls">
        <input type="file" id="fileInput" accept=".csv">
        
        <div class="badges">
            <div class="badge"><label>Market Regime</label><div id="regimeVal">---</div></div>
            <div class="badge"><label>Volatility</label><div id="volVal">---</div></div>
            <div class="badge"><label>Status</label><div id="statusVal" style="color:var(--gold)">IDLE</div></div>
        </div>
    </div>

    <div id="chart-container">
        <div class="watermark" id="watermark">LOAD A CSV FILE</div>
    </div>

    <div id="console">
        <div class="log-row">> System Initialized. Ready for CSV upload.</div>
    </div>

<script>
    // --- 1. LOGGER UTILS ---
    const consoleDiv = document.getElementById('console');
    function log(msg, type='') {
        const div = document.createElement('div');
        div.className = `log-row ${type}`;
        div.innerText = `> ${msg}`;
        consoleDiv.prepend(div);
    }

    // --- 2. CHART SETUP ---
    const chartDiv = document.getElementById('chart-container');
    const chart = LightweightCharts.createChart(chartDiv, {
        layout: { background: { color: '#000' }, textColor: '#888' },
        grid: { vertLines: { color: '#111' }, horzLines: { color: '#111' } },
        timeScale: { borderColor: '#333' },
        crosshair: { mode: 0 }
    });

    const candleSeries = chart.addCandlestickSeries({ upColor: '#089981', downColor: '#f23645', borderVisible: false });
    const simSeries = chart.addCandlestickSeries({ upColor: '#00FFFF', downColor: '#FF00FF', borderVisible: true, wickUpColor:'#00FFFF', wickDownColor:'#FF00FF' });

    window.addEventListener('resize', () => {
        chart.applyOptions({ width: chartDiv.clientWidth, height: chartDiv.clientHeight });
    });

    // --- 3. ROBUST PARSER (Specific to your files) ---
    const fileInput = document.getElementById('fileInput');
    
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        log(`Loading ${file.name} (${file.size} bytes)...`);
        document.getElementById('statusVal').innerText = "READING...";

        const reader = new FileReader();
        
        reader.onload = (evt) => {
            const text = evt.target.result;
            try {
                const data = parseCSV(text);
                
                // RENDER
                candleSeries.setData(data);
                document.getElementById('watermark').style.display = 'none';
                document.getElementById('statusVal').innerText = "ACTIVE";
                document.getElementById('statusVal').style.color = "#089981";
                
                // ANALYZE & SIMULATE
                runSimulation(data);
                
                chart.timeScale().fitContent();
                log(`Successfully rendered ${data.length} candles.`, 'success');

            } catch (err) {
                log(`ERROR: ${err.message}`, 'error');
                document.getElementById('statusVal').innerText = "ERROR";
                document.getElementById('statusVal').style.color = "#f23645";
            }
        };

        reader.onerror = () => log("Browser failed to read file.", 'error');
        reader.readAsText(file);
    });

    function parseCSV(rawText) {
        const lines = rawText.trim().split('\n');
        const data = [];
        
        // AUTO-DETECT HEADER ROW
        let startRow = 0;
        for(let i=0; i<Math.min(lines.length, 10); i++) {
            const row = lines[i].toLowerCase();
            if(row.includes('date') && row.includes('close')) {
                startRow = i + 1;
                log(`Header detected at line ${i+1}.`, 'warn');
                break;
            }
        }

        // PARSE LINES
        for (let i = startRow; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            // SIMPLE SPLIT (Works because first 5 cols are clean in your files)
            const parts = line.split(',');

            if (parts.length < 5) continue;

            try {
                // DATE (Col 0)
                let tStr = parts[0].replace(/["']/g, ''); // Clean quotes
                let timeVal;
                
                // Handle YYYY-MM-DD
                if (tStr.includes('-') || tStr.includes('/')) {
                    timeVal = new Date(tStr).getTime() / 1000;
                } else {
                    // Handle Unix/Serial
                    timeVal = parseFloat(tStr);
                }

                if (isNaN(timeVal)) continue;

                // PRICES (Cols 1-4)
                // We parse strictly these indices, ignoring the garbage at the end
                const o = parseFloat(parts[1]);
                const h = parseFloat(parts[2]);
                const l = parseFloat(parts[3]);
                const c = parseFloat(parts[4]);

                if (isNaN(c)) continue;

                data.push({ time: timeVal, open: o, high: h, low: l, close: c });

            } catch (e) {
                // Skip bad row
            }
        }

        if (data.length === 0) throw new Error("No valid data found. Check file format.");
        
        data.sort((a, b) => a.time - b.time);
        return data;
    }

    // --- 4. SIMULATION ENGINE ---
    function runSimulation(data) {
        log("Running Institutional Analysis...");
        
        // 1. VOLATILITY (ATR)
        const subset = data.slice(-20);
        let trSum = 0;
        for(let i=1; i<subset.length; i++) {
            const h = subset[i].high;
            const l = subset[i].low;
            const pc = subset[i-1].close;
            trSum += Math.max(h-l, Math.abs(h-pc), Math.abs(l-pc));
        }
        const atr = trSum / 19;
        
        // 2. TREND
        const start = subset[0].close;
        const end = subset[subset.length-1].close;
        const trendPct = ((end - start) / start) * 100;
        
        let regime = "RANGE";
        let color = "#fff";
        
        if (trendPct > 4) { regime = "STRONG BULL"; color = "#089981"; }
        else if (trendPct < -4) { regime = "STRONG BEAR"; color = "#f23645"; }
        else if (trendPct > 1) { regime = "WEAK BULL"; color = "#089981"; }
        else if (trendPct < -1) { regime = "WEAK BEAR"; color = "#f23645"; }

        // UPDATE UI
        const rEl = document.getElementById('regimeVal');
        rEl.innerText = regime;
        rEl.style.color = color;
        document.getElementById('volVal').innerText = atr.toFixed(2);

        // 3. GENERATE PROJECTION (30 Bars)
        const simData = [];
        let current = { ...data[data.length-1] };
        
        // Detect Interval (Daily vs Weekly)
        const interval = data.length > 1 ? (data[1].time - data[0].time) : 86400;

        // Apply Drift based on Regime
        let drift = 0;
        if(regime.includes("BULL")) drift = atr * 0.15;
        if(regime.includes("BEAR")) drift = -atr * 0.15;

        for(let i=0; i<30; i++) {
            // Monte Carlo Shock
            const shock = (Math.random() - 0.5) * atr;
            
            const open = current.close;
            const close = open + drift + shock;
            const high = Math.max(open, close) + (Math.random() * atr * 0.3);
            const low = Math.min(open, close) - (Math.random() * atr * 0.3);
            
            const nextTime = current.time + interval;
            current = { time: nextTime, open, high, low, close };
            simData.push(current);
        }
        
        simSeries.setData(simData);
        log("Projection generated (Cyan).", 'success');
    }
</script>
</body>
</html>
