<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeVision | Fail-Safe Loader</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: monospace; display: flex; flex-direction: column; height: 100vh; }
        
        /* CONTROLS - TOP BAR */
        .toolbar { 
            background: #222; padding: 20px; border-bottom: 2px solid #D4AF37; 
            display: flex; gap: 20px; align-items: center;
        }

        /* BIG UGLY BUTTON THAT WORKS */
        input[type="file"] {
            background: #fff; color: #000; padding: 10px; border-radius: 4px; cursor: pointer;
        }

        .status { font-size: 14px; color: #0f0; font-weight: bold; }
        .error { color: #f00; font-weight: bold; }

        /* STATS */
        .stats { display: flex; gap: 30px; margin-left: auto; font-size: 14px; }
        .stat-item span { color: #D4AF37; font-weight: bold; }

        /* CHART */
        #chart { flex-grow: 1; width: 100%; }
        
    </style>
</head>
<body>

<div class="toolbar">
    <div style="font-weight:bold; font-size:18px;">TradeVision</div>
    
    <input type="file" id="fileInput">
    
    <div id="status" class="status">WAITING FOR FILE...</div>

    <div class="stats">
        <div class="stat-item">REGIME: <span id="regime">---</span></div>
        <div class="stat-item">VOLATILITY: <span id="vol">---</span></div>
    </div>
</div>

<div id="chart"></div>

<script>
    // 1. SETUP CHART
    const chartDiv = document.getElementById('chart');
    const chart = LightweightCharts.createChart(chartDiv, {
        layout: { background: { color: '#000' }, textColor: '#888' },
        grid: { vertLines: { color: '#111' }, horzLines: { color: '#111' } },
        timeScale: { borderColor: '#333' }
    });
    
    const candleSeries = chart.addCandlestickSeries({ upColor: '#089981', downColor: '#f23645', borderVisible: false });
    const simSeries = chart.addCandlestickSeries({ upColor: '#0ff', downColor: '#f0f', borderVisible: true, wickUpColor:'#0ff', wickDownColor:'#f0f' });

    window.addEventListener('resize', () => {
        chart.applyOptions({ width: chartDiv.clientWidth, height: chartDiv.clientHeight });
    });

    // 2. FAIL-SAFE PARSER
    document.getElementById('fileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;

        const status = document.getElementById('status');
        status.innerText = "READING...";
        status.style.color = "yellow";

        const reader = new FileReader();
        reader.onload = (evt) => {
            const text = evt.target.result;
            const lines = text.trim().split('\n');
            
            const data = [];
            
            // Loop through lines
            for(let i=0; i<lines.length; i++) {
                const line = lines[i].trim();
                
                // IGNORE COMPLEX PARSING. JUST SPLIT BY COMMA.
                const parts = line.split(',');

                // We need at least 5 parts: Date, O, H, L, C
                if(parts.length < 5) continue;

                // TRY TO PARSE
                try {
                    // Part 0: Date
                    let tStr = parts[0].replace(/["']/g, ''); // Remove quotes
                    let timeVal;
                    
                    // Date Format Check
                    if(tStr.includes('-') || tStr.includes('/')) {
                        timeVal = new Date(tStr).getTime() / 1000;
                    } else {
                        // Maybe Header? If not number, skip
                        if(isNaN(parseFloat(tStr))) continue; 
                        timeVal = parseFloat(tStr); // Unix
                    }
                    
                    if(isNaN(timeVal)) continue;

                    // Parts 1-4: Prices
                    const o = parseFloat(parts[1].replace(/["']/g, ''));
                    const h = parseFloat(parts[2].replace(/["']/g, ''));
                    const l = parseFloat(parts[3].replace(/["']/g, ''));
                    const c = parseFloat(parts[4].replace(/["']/g, ''));

                    if(isNaN(c)) continue;

                    data.push({ time: timeVal, open: o, high: h, low: l, close: c });

                } catch(err) {
                    // Skip bad line
                }
            }

            if(data.length > 0) {
                // Success
                data.sort((a,b) => a.time - b.time);
                candleSeries.setData(data);
                chart.timeScale().fitContent();
                
                status.innerText = "LOADED: " + data.length + " BARS";
                status.style.color = "#0f0";
                
                // Run Engine
                runEngine(data);
            } else {
                status.innerText = "ERROR: NO VALID DATA FOUND";
                status.style.color = "#f00";
            }
        };
        reader.readAsText(file);
    });

    // 3. ENGINE LOGIC
    function runEngine(data) {
        // Analysis
        const lookback = data.slice(-20);
        let volSum = 0;
        lookback.forEach(d => volSum += (d.high - d.low));
        const avgVol = volSum / 20;
        const last = lookback[lookback.length-1];
        
        // Trend
        const start = lookback[0].close;
        const end = last.close;
        const change = ((end - start) / start) * 100;

        let regime = "RANGE";
        if(change > 3) regime = "BULLISH";
        if(change < -3) regime = "BEARISH";

        document.getElementById('regime').innerText = regime;
        document.getElementById('vol').innerText = (avgVol).toFixed(2);

        // Simulation
        const simData = [];
        let current = { ...last };
        
        // Interval
        const interval = data.length > 1 ? (data[1].time - data[0].time) : 86400;

        for(let i=0; i<30; i++) {
            const shock = (Math.random() - 0.5) * avgVol;
            const drift = (regime === "BULLISH" ? avgVol*0.2 : (regime === "BEARISH" ? -avgVol*0.2 : 0));
            
            const open = current.close;
            const close = open + drift + shock;
            const high = Math.max(open, close) + (Math.random() * avgVol * 0.3);
            const low = Math.min(open, close) - (Math.random() * avgVol * 0.3);
            
            const nextTime = current.time + interval;
            current = { time: nextTime, open, high, low, close };
            simData.push(current);
        }
        simSeries.setData(simData);
    }
</script>
</body>
</html>
